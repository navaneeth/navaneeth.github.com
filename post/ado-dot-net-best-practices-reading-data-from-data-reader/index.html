<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en-us lang=en-us><head><link href=https://gmpg.org/xfn/11 rel=profile><meta charset=utf-8><meta name=generator content="Hugo 0.83.1"><meta name=viewport content="width=device-width,initial-scale=1"><title>ADO.NET best practices – Reading data from data reader &#183; {love to code}</title><meta name=description content><link type=text/css rel=stylesheet href=https://navaneeth.github.io/css/print.css media=print><link type=text/css rel=stylesheet href=https://navaneeth.github.io/css/poole.css><link type=text/css rel=stylesheet href=https://navaneeth.github.io/css/syntax.css><link type=text/css rel=stylesheet href=https://navaneeth.github.io/css/hyde.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700"><link rel=apple-touch-icon-precomposed sizes=144x144 href=/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=/favicon.png></head><body><aside class=sidebar><div class="container sidebar-sticky"><div class=sidebar-about><a href=https://navaneeth.github.io/><h1>{love to code}</h1></a><p class=lead></p></div><nav><ul class=sidebar-nav><li><a href=https://navaneeth.github.io/>Home</a></li><li><a href=https://github.com/navaneeth/>Github</a></li><li><a href=https://twitter.com/navaneeth>Twitter</a></li></ul></nav><p>&copy; 2021. All rights reserved.</p></div></aside><main class="content container"><div class=post><h1>ADO.NET best practices – Reading data from data reader</h1><time datetime=2009-07-11T12:59:50+0530 class=post-date>Sat, Jul 11, 2009</time><p>I have seen many people using DataReader incorrectly. In this post, I will try to explain some good practices that can be followed when reading from a data reader. Consider the following problematic code,</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp>SqlDataReader reader = <span style=color:#75715e>/* ... */</span>;
<span style=color:#66d9ef>while</span> (reader.Read())
{
    <span style=color:#66d9ef>string</span> userName = reader[<span style=color:#e6db74>&#34;user_name&#34;</span>].ToString();
    <span style=color:#66d9ef>int</span> age = <span style=color:#66d9ef>int</span>.Parse( reader[<span style=color:#e6db74>&#34;age&#34;</span>].ToString() );
    <span style=color:#75715e>/* ... */</span>
}
reader.Close();
</code></pre></div><p>How many problems can you figure out from the above code? There are many problems with this code,</p><ul><li>The columns “user_name” and “age” may or may not exist. If the column does not exist in the reader, it will throw error.</li><li>You may be calling <code>ToString()</code> on an object which may be pointing to <code>NULL</code>. This will lead to a null reference exception.</li><li><code>SqlDataReader</code> implements <code>IDisposable</code> and user code has to call <code>Dispose()</code> each time to release the resources deterministically. This is not happening here.</li><li><code>reader["age"]</code> may contain values that are not compatible with integer. In such case, <code>int.Parse()</code> will throw a <code>FormatException</code>.</li></ul><p>Following sections will show a safe method to read data from DataReader.</p><h2 id=understanding-ordinals>Understanding ordinals</h2><p>Ordinal is the index of a column in the reader. <code>GetOrdinal()</code> method will give you the ordinal for the column name supplied. So the first step in reading data from reader should be to find the ordinal of the columns which we want to read. Before getting the ordinal values, you have to ensure that the reader can read. SqlDataReader provides a HasRows property which can be useful here. Here is how you read the ordinals</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp>SqlDataReader reader = <span style=color:#75715e>/* ... */</span>;
<span style=color:#66d9ef>int</span> userNameOrdinal;
<span style=color:#66d9ef>int</span> ageOrdinal;
<span style=color:#66d9ef>if</span> (reader.HasRows)
{
     <span style=color:#66d9ef>try</span>
     {
           userNameOrdinal = reader.GetOrdinal(<span style=color:#e6db74>&#34;user_name&#34;</span>);
     }
     <span style=color:#66d9ef>catch</span> (IndexOutOfRangeException)
     {
           <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> YourCustomException(<span style=color:#e6db74>&#34;Expected column &#39;user_name&#39; not found&#34;</span>);
     }
     <span style=color:#66d9ef>try</span>
     {
           ageOrdinal = reader.GetOrdinal(<span style=color:#e6db74>&#34;age&#34;</span>);
     }
     <span style=color:#66d9ef>catch</span> (IndexOutOfRangeException)
     {
           <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> YourCustomException(<span style=color:#e6db74>&#34;Expected column &#39;age&#39; not found&#34;</span>);
     }
}
</code></pre></div><p>If you have support to “Extension methods”, this code can be simplified further.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SqlDataReaderExtensions</span>
{
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>int</span> GetOrdinalOrThrow(<span style=color:#66d9ef>this</span> SqlDataReader reader, <span style=color:#66d9ef>string</span> columnName)
    {
        <span style=color:#66d9ef>try</span>
        {
            <span style=color:#66d9ef>return</span> reader.GetOrdinal(columnName);
        }
        <span style=color:#66d9ef>catch</span> (IndexOutOfRangeException)
        {
            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> YourCustomException(<span style=color:#66d9ef>string</span>.Format(<span style=color:#e6db74>&#34;Expected column &#39;{0}&#39; not found&#34;</span>,columnName));
        }
    }
}

SqlDataReader reader = <span style=color:#75715e>/* ... */</span>;
<span style=color:#66d9ef>int</span> userNameOrdinal;
<span style=color:#66d9ef>int</span> ageOrdinal;
<span style=color:#66d9ef>if</span> (reader.HasRows)
{
      userNameOrdinal = reader.GetOrdinalOrThrow(<span style=color:#e6db74>&#34;user_name&#34;</span>);
      ageOrdinal = reader.GetOrdinalOrThrow(<span style=color:#e6db74>&#34;age&#34;</span>);
}
</code></pre></div><p>This makes the code more clean. However, I really wish to see a <code>TryGetOrdinal()</code> method on <code>IDataReader</code> so that we can save the cost of exception handling.</p><p>GetOrdinal() method first does a case-sensitive lookup for the column name. If it fails, case-insensitive search is performed. Thus, using the column name in correct case with GetOrdinal() will be more efficient.</p><h2 id=respecting-type-safety>Respecting type safety</h2><p>C# is a strongly typed language and each programmer should take full advantage of this. Reading data like, <code>reader["user_name"]</code> is not a type safe way as it returns a object. Data reader provides methods to read data in a type safe way.</p><p>Here is what MSDN says about it</p><blockquote><pre><code>When accessing column data use the typed accessors like GetString, GetInt32, and so on. This saves you the processing required to cast the Object returned from GetValue as a particular type.
</code></pre></blockquote><p>Now let us follow the above suggestion and rewrite our code like,</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=color:#66d9ef>while</span> (reader.Read())
{
   <span style=color:#66d9ef>string</span> userName = reader.GetString(userNameOrdinal);
   <span style=color:#66d9ef>int</span> age = -<span style=color:#ae81ff>1</span>;
   <span style=color:#66d9ef>try</span>
   {
         age = reader.GetInt32(ageOrdinal);
   }
   <span style=color:#66d9ef>catch</span> (InvalidCastException)
   {
         <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> YourCustomException(<span style=color:#e6db74>&#34;Unable to read age. Expecting integer value&#34;</span>);
   }
   <span style=color:#75715e>/* ... */</span>
}
</code></pre></div><h2 id=releasing-resources>Releasing resources</h2><p>If any type implements IDisposable, it is like saying “I have something to release explicitly rather than garbage collector to release it“. So it is programmers duty to ensure the calls to Dispose() when using disposable types. C# has “using” statement (stack semantics can be used in C++/CLI) which will ensure calls to Dispose(). Since DataReader is a disposable object, we can write like</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp>using(SqlDataReader reader = command.ExecuteReader())
{
      <span style=color:#66d9ef>while</span> (reader.Read())
      {
          <span style=color:#66d9ef>string</span> userName = reader.GetString(userNameOrdinal);
          <span style=color:#66d9ef>int</span> age = -<span style=color:#ae81ff>1</span>;
          <span style=color:#66d9ef>try</span>
          {
              age = reader.GetInt32(ageOrdinal);
          }
          <span style=color:#66d9ef>catch</span> (InvalidCastException)
          {
              <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> YourCustomException(<span style=color:#e6db74>&#34;Unable to read age. Expecting integer value&#34;</span>);
          }
          <span style=color:#75715e>/* ... */</span>
      }
}
</code></pre></div><p>This ensures that the reader is disposed properly even in exceptional situations.</p><h2 id=putting-everything-together>Putting everything together</h2><p>If you put everything together, code will be like</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>SqlDataReaderExtensions</span>
{
    <span style=color:#66d9ef>public</span> <span style=color:#66d9ef>static</span> <span style=color:#66d9ef>int</span> GetOrdinalOrThrow(<span style=color:#66d9ef>this</span> SqlDataReader reader, <span style=color:#66d9ef>string</span> columnName)
    {
        <span style=color:#66d9ef>try</span>
        {
            <span style=color:#66d9ef>return</span> reader.GetOrdinal(columnName);
        }
        <span style=color:#66d9ef>catch</span> (IndexOutOfRangeException)
        {
            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> YourCustomException(<span style=color:#66d9ef>string</span>.Format(<span style=color:#e6db74>&#34;Expected column &#39;{0}&#39; not found&#34;</span>,columnName));
        }
    }
}

<span style=color:#66d9ef>int</span> userNameOrdinal = -<span style=color:#ae81ff>1</span>;
<span style=color:#66d9ef>int</span> ageOrdinal = -<span style=color:#ae81ff>1</span>;
<span style=color:#66d9ef>if</span> (reader.HasRows)
{
    userNameOrdinal = reader.GetOrdinalOrThrow(<span style=color:#e6db74>&#34;user_name&#34;</span>);
    ageOrdinal = reader.GetOrdinalOrThrow(<span style=color:#e6db74>&#34;age&#34;</span>);
}
<span style=color:#66d9ef>using</span> (SqlDataReader reader = GetReader())
{
    <span style=color:#66d9ef>while</span> (reader.Read())
    {
        <span style=color:#66d9ef>string</span> userName = reader.GetString(userNameOrdinal);
        <span style=color:#66d9ef>int</span> age = -<span style=color:#ae81ff>1</span>;
        <span style=color:#66d9ef>try</span>
        {
            age = reader.GetInt32(ageOrdinal);
        }
        <span style=color:#66d9ef>catch</span> (InvalidCastException)
        {
            <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> YourCustomException(<span style=color:#e6db74>&#34;Unable to read age. Expecting integer value&#34;</span>);
        }
        <span style=color:#75715e>/* ... */</span>
    }
}
</code></pre></div><p>We have got clean code now. It handles the exceptions and throws informative exceptions to the caller rather than throwing Boneheaded exceptions, we have avoided explicit casting and DataReader is disposed properly.</p><p>These are applicable for all types which implements <code>IDataReader</code>. <code>SqlDataReader</code> is used in this post just for explanation.</p><p>Happy programming!</p></div></main></body></html>