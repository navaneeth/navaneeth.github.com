<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en-us lang=en-us><head><link href=https://gmpg.org/xfn/11 rel=profile><meta charset=utf-8><meta name=generator content="Hugo 0.83.1"><meta name=viewport content="width=device-width,initial-scale=1"><title>Function strdup implicitly converted to pointer &#183; {love to code}</title><meta name=description content><link type=text/css rel=stylesheet href=https://navaneeth.github.io/css/print.css media=print><link type=text/css rel=stylesheet href=https://navaneeth.github.io/css/poole.css><link type=text/css rel=stylesheet href=https://navaneeth.github.io/css/syntax.css><link type=text/css rel=stylesheet href=https://navaneeth.github.io/css/hyde.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700"><link rel=apple-touch-icon-precomposed sizes=144x144 href=/apple-touch-icon-144-precomposed.png><link rel="shortcut icon" href=/favicon.png></head><body><aside class=sidebar><div class="container sidebar-sticky"><div class=sidebar-about><a href=https://navaneeth.github.io/><h1>{love to code}</h1></a><p class=lead></p></div><nav><ul class=sidebar-nav><li><a href=https://navaneeth.github.io/>Home</a></li><li><a href=https://github.com/navaneeth/>Github</a></li><li><a href=https://twitter.com/navaneeth>Twitter</a></li></ul></nav><p>&copy; 2021. All rights reserved.</p></div></aside><main class="content container"><div class=post><h1>Function strdup implicitly converted to pointer</h1><time datetime=2015-05-21T10:50:48+0530 class=post-date>Thu, May 21, 2015</time><p>I was trying to make a debian package for <a href=http://varnamproject.com>libvarnam</a>. Lot of work went into making the package ready. Debian has very strict rules about how the packaging should be done. Debian also marks few errors as fatal and which may require a code change to fix it. One of the errors I faced was the following:</p><blockquote><p>Our automated build log filter detected the problem(s) above that will
likely cause your package to segfault on architectures where the size of
a pointer is greater than the size of an integer, such as ia64 and amd64.</p></blockquote><blockquote><p>This is often due to a missing function prototype definition.</p></blockquote><blockquote><p>Since use of implicitly converted pointers is always fatal to the application
on ia64, they are errors. Please correct them for your next upload.</p></blockquote><blockquote><p>More information can be found at: <a href=http://wiki.debian.org/ImplicitPointerConversions>http://wiki.debian.org/ImplicitPointerConversions</a></p></blockquote><p>The above error failed the build.</p><p>The relevant code where the failure happened looks like the following:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#66d9ef>char</span><span style=color:#f92672>*</span>
<span style=color:#a6e22e>strbuf_get_last_unicode_char</span>(strbuf <span style=color:#f92672>*</span>word)
{
  varray <span style=color:#f92672>*</span>characters <span style=color:#f92672>=</span> NULL;
  <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>lastUnicodeChar <span style=color:#f92672>=</span> NULL;
  characters <span style=color:#f92672>=</span> strbuf_chars(word);

  <span style=color:#66d9ef>if</span> (varray_is_empty (characters)) {
    varray_free (characters, NULL);
    <span style=color:#66d9ef>return</span> NULL;
  }

  lastUnicodeChar <span style=color:#f92672>=</span> strdup ((<span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span><span style=color:#f92672>*</span>) varray_get(characters, varray_length(characters) <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>)); <span style=color:#75715e>/* -&gt; Error here */</span>
  varray_free(characters, <span style=color:#f92672>&amp;</span>free);
  <span style=color:#75715e>/*ending should be freed in the calling function*/</span>
  <span style=color:#66d9ef>return</span> lastUnicodeChar;
}
</code></pre></div><p><code>strdup</code> is not a ANSI C function, hence it is not portable and not available with all compilers. This has caused the function prototype to be not found. When a function prototype is missing, gcc by default return an integer value. De-referencing the returned pointer will cause a segfault.</p><p>To fix this, I found a portable <code>strdup</code> implementation in the OpenBSD source code. I have used that and disabled the default <code>strdup</code>.</p></div></main></body></html>