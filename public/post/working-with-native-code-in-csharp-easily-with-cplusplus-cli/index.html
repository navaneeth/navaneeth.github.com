<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>Working with native code easily in C# with the help of C&#43;&#43;/CLI &middot; nkn</title>

  
  <link rel="stylesheet" href="https://navaneeth.github.io/css/poole.css">
  <link rel="stylesheet" href="https://navaneeth.github.io/css/hyde.css">
  <link rel="stylesheet" href="https://navaneeth.github.io/css/poole-overrides.css">
  <link rel="stylesheet" href="https://navaneeth.github.io/css/hyde-overrides.css">
  <link rel="stylesheet" href="https://navaneeth.github.io/css/hyde-x.css">
  <link rel="stylesheet" href="https://navaneeth.github.io/css/highlight/sunburst.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
  

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://navaneeth.github.io/touch-icon-144-precomposed.png">
  <link href="https://navaneeth.github.io/favicon.png" rel="icon">

  
  
  
  

  <meta name="description" content="">
  <meta name="keywords" content="">
  
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-38544003-1', 'auto');
    ga('send', 'pageview');
  </script>
  
</head>
<body>
<div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      
      <h1>nkn</h1>
      <p class="lead">{love to code}</p>
    </div>

    <ul class="sidebar-nav">
      <li class="sidebar-nav-item"><a href="https://navaneeth.github.io/">blog</a></li>
      
      <li class="sidebar-nav-item"><a href="https://navaneeth.github.io/about/">about</a></li>
      
    </ul>

    <ul class="sidebar-nav">
      <li class="sidebar-nav-item">
      <a href="https://github.com/navaneeth/"><i class="fa fa-github-square fa-3x"></i></a>
      
      
      
      
      
      <a href="http://twitter.com/navaneethkn"><i class="fa fa-twitter-square fa-3x"></i></a>
      
      <a href="https://navaneeth.github.io/index.xml" type="application/rss+xml"><i class="fa fa-rss-square fa-3x"></i></a>
      </li>
    </ul>

    

    <p>Copyright &copy; 2021 <a href="https://navaneeth.github.io/license/">License</a><br/>
       Powered by <a href="http://gohugo.io">Hugo</a> and <a href="https://github.com/zyro/hyde-x">Hyde-X</a></p>

  </div>
</div>


<div class="content container">
  <div class="post">
    <h1 class="post-title">Working with native code easily in C# with the help of C&#43;&#43;/CLI</h1>
    <span class="post-date">Feb 17, 2013 &middot; 6 minute read
    
    <br/>
    <a class="label" href="https://navaneeth.github.io/categories/programming">programming</a><a class="label" href="https://navaneeth.github.io/categories/.net">.net</a><a class="label" href="https://navaneeth.github.io/categories/c&#43;&#43;/cli">c&#43;&#43;/cli</a>
    </span>
    <p>.NET comes with pretty good interoperability options which would enable unmanaged code to be used from a managed environment. In C#, to call a function which is available in a DLL, <code>PInvoke</code> (Platform invocation service) can be used. Here is what MSDN says.</p>
<blockquote>
<p>Platform Invocation Services (PInvoke) allows managed code to call unmanaged functions that are implemented in a DLL.</p>
</blockquote>
<p>This is very helpful when you need to call some system functions from your C# application. Now let us assume that you have lot of code which is written in C or C++. You are writing a brand new application in C# which internally uses the C/C++ code available. Since C/C++ code is categorised as unmanaged code, you can&rsquo;t directly use them in C#. At C# side, wrapper classes and functions has to be written to interop properly with the native code. As I said earlier, if you just need to use a single function, it is easy to do directly from C# using <code>PInvoke</code>. But when you need almost all the functionalities/API to be available as a managed object, <code>PInvoke</code> would be a pain to use. Let us take an example from <a href="http://msdn.microsoft.com/en-us/library/aa288468%28v=vs.71%29.aspx">MSDN</a></p>
<div class="highlight"><pre class="chroma"><code class="language-c" data-lang="c"><span class="k">typedef</span> <span class="k">struct</span> <span class="n">tagLOGFONT</span>
<span class="p">{</span>
   <span class="n">LONG</span> <span class="n">lfHeight</span><span class="p">;</span>
   <span class="n">LONG</span> <span class="n">lfWidth</span><span class="p">;</span>
   <span class="n">LONG</span> <span class="n">lfEscapement</span><span class="p">;</span>
   <span class="n">LONG</span> <span class="n">lfOrientation</span><span class="p">;</span>
   <span class="n">LONG</span> <span class="n">lfWeight</span><span class="p">;</span>
   <span class="n">BYTE</span> <span class="n">lfItalic</span><span class="p">;</span>
   <span class="n">BYTE</span> <span class="n">lfUnderline</span><span class="p">;</span>
   <span class="n">BYTE</span> <span class="n">lfStrikeOut</span><span class="p">;</span>
   <span class="n">BYTE</span> <span class="n">lfCharSet</span><span class="p">;</span>
   <span class="n">BYTE</span> <span class="n">lfOutPrecision</span><span class="p">;</span>
   <span class="n">BYTE</span> <span class="n">lfClipPrecision</span><span class="p">;</span>
   <span class="n">BYTE</span> <span class="n">lfQuality</span><span class="p">;</span>
   <span class="n">BYTE</span> <span class="n">lfPitchAndFamily</span><span class="p">;</span>
   <span class="n">TCHAR</span> <span class="n">lfFaceName</span><span class="p">[</span><span class="n">LF_FACESIZE</span><span class="p">];</span>
<span class="p">}</span> <span class="n">LOGFONT</span><span class="p">;</span>
</code></pre></div><p>In C#, this can be represented as</p>
<div class="highlight"><pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="c1">// logfont.cs
</span><span class="c1">// compile with: /target:module
</span><span class="c1"></span><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.Runtime.InteropServices</span><span class="p">;</span>
<span class="na">
</span><span class="na">[StructLayout(LayoutKind.Sequential)]</span>
<span class="k">public</span> <span class="k">class</span> <span class="nc">LOGFONT</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">LF_FACESIZE</span> <span class="p">=</span> <span class="m">32</span><span class="p">;</span>
    <span class="k">public</span> <span class="kt">int</span> <span class="n">lfHeight</span><span class="p">;</span>
    <span class="k">public</span> <span class="kt">int</span> <span class="n">lfWidth</span><span class="p">;</span>
    <span class="k">public</span> <span class="kt">int</span> <span class="n">lfEscapement</span><span class="p">;</span>
    <span class="k">public</span> <span class="kt">int</span> <span class="n">lfOrientation</span><span class="p">;</span>
    <span class="k">public</span> <span class="kt">int</span> <span class="n">lfWeight</span><span class="p">;</span>
    <span class="k">public</span> <span class="kt">byte</span> <span class="n">lfItalic</span><span class="p">;</span>
    <span class="k">public</span> <span class="kt">byte</span> <span class="n">lfUnderline</span><span class="p">;</span>
    <span class="k">public</span> <span class="kt">byte</span> <span class="n">lfStrikeOut</span><span class="p">;</span>
    <span class="k">public</span> <span class="kt">byte</span> <span class="n">lfCharSet</span><span class="p">;</span>
    <span class="k">public</span> <span class="kt">byte</span> <span class="n">lfOutPrecision</span><span class="p">;</span>
    <span class="k">public</span> <span class="kt">byte</span> <span class="n">lfClipPrecision</span><span class="p">;</span>
    <span class="k">public</span> <span class="kt">byte</span> <span class="n">lfQuality</span><span class="p">;</span>
    <span class="k">public</span> <span class="kt">byte</span> <span class="n">lfPitchAndFamily</span><span class="p">;</span>
<span class="na">
</span><span class="na">    [MarshalAs(UnmanagedType.ByValTStr, SizeConst=LF_FACESIZE)]</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">lfFaceName</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div><p>Look at the C# example. It is not as clean as the structure definition at the C side. It contains attributes which specify the structure alignment, then marshaling etc. When the structure contains references to other structures, things gets complicated.</p>
<p>For C or C++ programmers, it is always convenient to declare the struct as they normally do. That&rsquo;s the beauty of <code>C++/CLI</code> which allows you to combine managed and unmanaged code together and makes interoperability very straightforward.</p>
<p>In this post, we will take <code>SQLite</code> as an example and write a managed class which can be consumed from C#. We will wrap SQLite code using <code>C++/CLI</code> and consume from C#. SQLite has a huge API and we won&rsquo;t be covering all of them. We will cover APIs which will allow to open a DB connection and execute a simple query.</p>
<p>Note: SQLite is chosen as an example. The correct way to wrap SQLite is adhering to ADO.NET standards and providing a API by extending IDBConnection. But for this post, we will ignore this and provide a custom simple API.</p>
<h2 id="sqlite-api">SQLite API</h2>
<p>We will wrap the following functions</p>
<div class="highlight"><pre class="chroma"><code class="language-c" data-lang="c"><span class="kt">int</span> <span class="nf">sqlite3_open</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">,</span> <span class="n">sqlite3</span> <span class="o">**</span><span class="n">ppDb</span><span class="p">);</span>
<span class="kt">int</span> <span class="nf">sqlite3_exec</span><span class="p">(</span>
  <span class="n">sqlite3</span><span class="o">*</span><span class="p">,</span>                                  <span class="cm">/* An open database */</span>
  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">sql</span><span class="p">,</span>                           <span class="cm">/* SQL to be evaluated */</span>
  <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">callback</span><span class="p">)(</span><span class="kt">void</span><span class="o">*</span><span class="p">,</span><span class="kt">int</span><span class="p">,</span><span class="kt">char</span><span class="o">**</span><span class="p">,</span><span class="kt">char</span><span class="o">**</span><span class="p">),</span>  <span class="cm">/* Callback function */</span>
  <span class="kt">void</span> <span class="o">*</span><span class="p">,</span>                                    <span class="cm">/* 1st argument to callback */</span>
  <span class="kt">char</span> <span class="o">**</span><span class="n">errmsg</span>                              <span class="cm">/* Error msg written here */</span>
<span class="p">);</span>
</code></pre></div><p>Our managed API will look like,</p>
<div class="highlight"><pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="n">SQLite</span> <span class="n">db</span> <span class="p">=</span> <span class="k">new</span> <span class="n">SQLite</span><span class="p">(</span><span class="n">filePath</span><span class="p">);</span>
<span class="n">db</span><span class="p">.</span><span class="n">Execute</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="n">callback</span><span class="p">);</span>
</code></pre></div><p><code>callback</code> can be assigned to a function which takes 2 parameters of type <code>List&lt;String&gt;</code>. It will contain column names and values respectively.</p>
<h2 id="wrapper-class-in-ccli">Wrapper class in C++/CLI</h2>
<p>We will have a Visual studio solution with 3 projects.</p>
<ul>
<li>Static library which contains SQLite source code. This will be compiled as C and produces a static library.</li>
<li>C++/CLI library project which adds the first project as a reference.</li>
<li>A C# console application for testing. This project will have a reference to the assembly generated by C++/CLI project.</li>
</ul>
<p><img src="/images/posts/20130217/solution_explorer.png" alt="Solution explorer"></p>
<p>In C++/CLI, we start off by creating the following class.</p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="c1">// SQLiteWrapper.h
</span><span class="c1"></span>
<span class="cp">#pragma once
</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&#34;sqlite3.h&#34;</span><span class="cp">
</span><span class="cp"></span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">System</span><span class="p">;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">System</span><span class="o">::</span><span class="n">Collections</span><span class="o">::</span><span class="n">Generic</span><span class="p">;</span>

<span class="k">namespace</span> <span class="n">SQLiteWrapper</span> <span class="p">{</span>

    <span class="c1">// Main class that wraps the native API
</span><span class="c1"></span>    <span class="k">public</span> <span class="n">ref</span> <span class="k">class</span> <span class="nc">SQLite</span> <span class="o">:</span> <span class="n">IDisposable</span>
    <span class="p">{</span>
    <span class="k">public</span><span class="o">:</span>
        <span class="n">SQLite</span><span class="p">(</span><span class="n">String</span><span class="o">^</span> <span class="n">filePath</span><span class="p">);</span>
        <span class="kt">void</span> <span class="nf">Execute</span><span class="p">(</span><span class="n">String</span><span class="o">^</span> <span class="n">sql</span><span class="p">,</span> <span class="n">Action</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">^&gt;^</span><span class="p">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">^&gt;^&gt;^</span> <span class="n">callback</span><span class="p">);</span>
        <span class="o">~</span><span class="n">SQLite</span><span class="p">();</span>

    <span class="k">private</span><span class="o">:</span>
        <span class="n">sqlite3</span><span class="o">*</span> <span class="n">db</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="k">public</span> <span class="n">ref</span> <span class="k">class</span> <span class="nc">SQLiteError</span> <span class="o">:</span> <span class="n">Exception</span>
    <span class="p">{</span>
    <span class="k">public</span><span class="o">:</span>
        <span class="n">SQLiteError</span><span class="p">(</span><span class="n">String</span><span class="o">^</span> <span class="n">errorMessage</span><span class="p">);</span>
    <span class="p">};</span>

    <span class="k">private</span> <span class="n">ref</span> <span class="k">class</span> <span class="nc">SQLiteDataCarrier</span>
    <span class="p">{</span>
    <span class="k">public</span><span class="o">:</span>
        <span class="n">SQLiteDataCarrier</span><span class="p">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">^&gt;^</span> <span class="n">columnNames</span><span class="p">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">^&gt;^</span> <span class="n">columnValues</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">this</span><span class="o">-&gt;</span><span class="n">columnNames</span> <span class="o">=</span> <span class="n">columnNames</span><span class="p">;</span>
            <span class="k">this</span><span class="o">-&gt;</span><span class="n">columnValues</span> <span class="o">=</span> <span class="n">columnValues</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">property</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">^&gt;^</span> <span class="n">ColumnNames</span>
        <span class="p">{</span>
            <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">^&gt;^</span> <span class="n">get</span><span class="p">()</span>
            <span class="p">{</span>
                <span class="k">return</span> <span class="n">columnNames</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="n">property</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">^&gt;^</span> <span class="n">ColumnValues</span>
        <span class="p">{</span>
            <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">^&gt;^</span> <span class="n">get</span><span class="p">()</span>
            <span class="p">{</span>
                <span class="k">return</span> <span class="n">columnValues</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

    <span class="k">private</span><span class="o">:</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">^&gt;^</span> <span class="n">columnNames</span><span class="p">;</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">^&gt;^</span> <span class="n">columnValues</span><span class="p">;</span>
    <span class="p">};</span>
<span class="p">}</span>
</code></pre></div><p>This class holds an instance to <code>sqlite3</code> structure which is the core of SQLite library. Even though the class is a managed class, C++/CLI allows you to hold a pointer which points to <code>sqlite3</code>.</p>
<p>Our constructor can be implemented like,</p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="c1">// Constructor for managed class SQLite
</span><span class="c1"></span><span class="n">SQLite</span><span class="o">::</span><span class="n">SQLite</span><span class="p">(</span><span class="n">String</span><span class="o">^</span> <span class="n">filePath</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">IntPtr</span> <span class="n">p</span> <span class="o">=</span> <span class="n">Marshal</span><span class="o">::</span><span class="n">StringToHGlobalAnsi</span><span class="p">(</span><span class="n">filePath</span><span class="p">);</span>
    <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">_filePath</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="kt">char</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">ToPointer</span><span class="p">());</span>

    <span class="k">try</span>
    <span class="p">{</span>
        <span class="n">sqlite3</span><span class="o">*</span> <span class="n">d</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">sqlite3_open</span><span class="p">(</span><span class="n">_filePath</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">d</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span>
            <span class="k">throw</span> <span class="n">gcnew</span> <span class="n">SQLiteError</span><span class="p">(</span><span class="s">&#34;Unable to open database&#34;</span><span class="p">);</span>


        <span class="c1">// Holding the DB pointer as a field
</span><span class="c1"></span>        <span class="c1">// This is a pointer to native struct, but it can be stored in managed class!
</span><span class="c1"></span>        <span class="n">db</span> <span class="o">=</span> <span class="n">d</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">finally</span>
    <span class="p">{</span>
        <span class="n">Marshal</span><span class="o">::</span><span class="n">FreeHGlobal</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>

    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p>This code shows how well C++/CLI allows you to mix types from both managed and unmanaged world. It is beautiful!</p>
<p>All this constructor does is to initialize <code>sqlite3</code> instance and update the <code>db</code> pointer with correct reference.</p>
<p>Here is how <code>Execute()</code> method is implemented.</p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="c1">// Callback function called by SQLite.
</span><span class="c1">// This function shows how native and managed objects can work together!
</span><span class="c1"></span><span class="k">static</span> <span class="kt">int</span> <span class="nf">_callback</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">userData</span><span class="p">,</span> <span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">azColName</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">IntPtr</span> <span class="n">pointer</span><span class="p">(</span><span class="n">userData</span><span class="p">);</span>
    <span class="n">GCHandle</span> <span class="n">handle</span> <span class="o">=</span> <span class="n">GCHandle</span><span class="o">::</span><span class="n">FromIntPtr</span><span class="p">(</span><span class="n">pointer</span><span class="p">);</span>
    <span class="n">SQLiteDataCarrier</span><span class="o">^</span> <span class="n">carrier</span> <span class="o">=</span> <span class="p">(</span><span class="n">SQLiteDataCarrier</span><span class="o">^</span><span class="p">)</span> <span class="n">handle</span><span class="p">.</span><span class="n">Target</span><span class="p">;</span>

    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">argc</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">columnName</span> <span class="o">=</span> <span class="n">azColName</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
        <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">columnValue</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

        <span class="n">carrier</span><span class="o">-&gt;</span><span class="n">ColumnNames</span><span class="o">-&gt;</span><span class="n">Add</span><span class="p">(</span><span class="n">gcnew</span> <span class="n">String</span><span class="p">(</span><span class="n">columnName</span><span class="p">));</span>
        <span class="n">carrier</span><span class="o">-&gt;</span><span class="n">ColumnValues</span><span class="o">-&gt;</span><span class="n">Add</span><span class="p">(</span><span class="n">gcnew</span> <span class="n">String</span><span class="p">(</span><span class="n">columnValue</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="n">SQLite</span><span class="o">::</span><span class="n">Execute</span><span class="p">(</span><span class="n">String</span><span class="o">^</span> <span class="n">sql</span><span class="p">,</span> <span class="n">Action</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">^&gt;^</span><span class="p">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">^&gt;^&gt;^</span> <span class="n">callback</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">IntPtr</span> <span class="n">p</span> <span class="o">=</span> <span class="n">Marshal</span><span class="o">::</span><span class="n">StringToHGlobalAnsi</span><span class="p">(</span><span class="n">sql</span><span class="p">);</span>
    <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">_sql</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="kt">char</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">p</span><span class="p">.</span><span class="n">ToPointer</span><span class="p">());</span>

    <span class="c1">// Output will be stored in these lists
</span><span class="c1"></span>    <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">^&gt;^</span> <span class="n">columnNames</span> <span class="o">=</span> <span class="n">gcnew</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">^&gt;</span><span class="p">();</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">^&gt;^</span> <span class="n">columnValues</span> <span class="o">=</span> <span class="n">gcnew</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">^&gt;</span><span class="p">();</span>

    <span class="c1">// A simple class to aggregate columnNames and columnValues so that it can be passed to SQLite and SQLite will give it back in the callback function
</span><span class="c1"></span>    <span class="n">SQLiteDataCarrier</span><span class="o">^</span> <span class="n">carrier</span> <span class="o">=</span> <span class="n">gcnew</span> <span class="n">SQLiteDataCarrier</span><span class="p">(</span><span class="n">columnNames</span><span class="p">,</span> <span class="n">columnValues</span><span class="p">);</span>

    <span class="c1">// Converting carrier to void*
</span><span class="c1"></span>    <span class="n">GCHandle</span> <span class="n">handle</span> <span class="o">=</span> <span class="n">GCHandle</span><span class="o">::</span><span class="n">Alloc</span><span class="p">(</span><span class="n">carrier</span><span class="p">);</span>
    <span class="n">IntPtr</span> <span class="n">pointer</span> <span class="o">=</span> <span class="n">GCHandle</span><span class="o">::</span><span class="n">ToIntPtr</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>

    <span class="kt">char</span> <span class="o">*</span><span class="n">zErrMsg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">sqlite3_exec</span><span class="p">(</span><span class="n">db</span><span class="p">,</span> <span class="n">_sql</span><span class="p">,</span> <span class="n">_callback</span><span class="p">,</span> <span class="n">pointer</span><span class="p">.</span><span class="n">ToPointer</span><span class="p">(),</span> <span class="o">&amp;</span><span class="n">zErrMsg</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">SQLITE_OK</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">String</span><span class="o">^</span> <span class="n">message</span> <span class="o">=</span> <span class="n">gcnew</span> <span class="n">String</span><span class="p">(</span><span class="n">sqlite3_errmsg</span><span class="p">(</span><span class="n">db</span><span class="p">));</span>
        <span class="k">throw</span> <span class="n">gcnew</span> <span class="nf">SQLiteError</span><span class="p">(</span><span class="n">message</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">callback</span><span class="o">-&gt;</span><span class="n">Invoke</span><span class="p">(</span><span class="n">columnNames</span><span class="p">,</span> <span class="n">columnValues</span><span class="p">);</span>

    <span class="n">handle</span><span class="p">.</span><span class="n">Free</span><span class="p">();</span>
    <span class="n">Marshal</span><span class="o">::</span><span class="n">FreeHGlobal</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div><p>To add results into the list, we are passing both lists to the <code>sqlite3_exec()</code> function so that SQLite will pass that back to the <code>_callback</code> function. This is very powerful because we just passed a managed object into a native function call. Then in a native function, we obtained the managed instance and modified properties on it.</p>
<p>Once the querying is done, database has to be closed. We do that in the destructor.</p>
<div class="highlight"><pre class="chroma"><code class="language-c++" data-lang="c++"><span class="c1">// In C++/CLI destructor will be implemented using Dispose() pattern
</span><span class="c1"></span><span class="n">SQLite</span><span class="o">::~</span><span class="n">SQLite</span><span class="p">()</span>
<span class="p">{</span>
    <span class="n">sqlite3_close</span><span class="p">(</span><span class="n">db</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div><h2 id="using-from-c">Using from C#</h2>
<p>Usage from C# now becomes pretty straightforward.</p>
<div class="highlight"><pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="k">namespace</span> <span class="nn">ConsoleApplication1</span>
<span class="p">{</span>
    <span class="k">class</span> <span class="nc">Program</span>
    <span class="p">{</span>
        <span class="k">static</span> <span class="k">void</span> <span class="n">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">SQLite</span> <span class="n">db</span> <span class="p">=</span> <span class="k">new</span> <span class="n">SQLite</span><span class="p">(</span><span class="s">&#34;C:\\Users\\navaneeth\\Desktop\\test\\example.db&#34;</span><span class="p">);</span>
            <span class="kt">string</span> <span class="n">sql</span> <span class="p">=</span> <span class="s">&#34;create table if not exists foos (name text);\n&#34;</span> <span class="p">+</span>
                <span class="s">&#34;insert into foos values (&#39;sample1&#39;);&#34;</span> <span class="p">+</span>
                <span class="s">&#34;insert into foos values (&#39;sample2&#39;);&#34;</span> <span class="p">+</span>
                <span class="s">&#34;select * from foos;&#34;</span><span class="p">;</span>
            <span class="n">db</span><span class="p">.</span><span class="n">Execute</span><span class="p">(</span><span class="n">sql</span><span class="p">,</span> <span class="p">(</span><span class="n">columnNames</span><span class="p">,</span> <span class="n">columnValues</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="p">{</span>
                <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">name</span> <span class="k">in</span> <span class="n">columnNames</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="n">name</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="k">value</span> <span class="k">in</span> <span class="n">columnValues</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="k">value</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">});</span>
            <span class="n">db</span><span class="p">.</span><span class="n">Dispose</span><span class="p">();</span>
            <span class="n">Console</span><span class="p">.</span><span class="n">Read</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p>You can download the code <a href="https://dl.dropbox.com/u/52296034/blog/SQLiteWrapper.zip">here</a>. Happy programming!</p>

  </div>
  
</div>




<script src="https://navaneeth.github.io/js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
</body>
</html>

